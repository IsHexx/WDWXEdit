/*
 * Copyright (c) 2024-2025 IsHexx
 * All rights reserved.
 *
 * This software is proprietary and confidential. No part of this software
 * may be reproduced, distributed, or transmitted in any form or by any means,
 * including photocopying, recording, or other electronic or mechanical methods,
 * without the prior written permission of the author, except in the case of
 * brief quotations embodied in critical reviews and certain other noncommercial
 * uses permitted by copyright law.
 *
 * For permission requests, contact: IsHexx
 */
import { sanitizeHTMLToDom, Platform } from "obsidian";
import * as postcss from "./postcss/postcss";
let PluginVersion = "0.0.0";
let PlugPlatform = "obsidian";
export function setVersion(version) {
    PluginVersion = version;
    if (Platform.isWin) {
        PlugPlatform = "win";
    }
    else if (Platform.isMacOS) {
        PlugPlatform = "mac";
    }
    else if (Platform.isLinux) {
        PlugPlatform = "linux";
    }
    else if (Platform.isIosApp) {
        PlugPlatform = "ios";
    }
    else if (Platform.isAndroidApp) {
        PlugPlatform = "android";
    }
}
// Claude Code Update
function getStyleSheet() {
    for (let i = 0; i < document.styleSheets.length; i++) {
        const sheet = document.styleSheets[i];
        if (sheet.title == 'wdwxedit-style') {
            return sheet;
        }
    }
}
function applyStyles(element, styles, computedStyle) {
    for (let i = 0; i < styles.length; i++) {
        const propertyName = styles[i];
        let propertyValue = computedStyle.getPropertyValue(propertyName);
        if (propertyName == 'width' && styles.getPropertyValue(propertyName) == 'fit-content') {
            propertyValue = 'fit-content';
        }
        if (propertyName.indexOf('margin') >= 0 && styles.getPropertyValue(propertyName).indexOf('auto') >= 0) {
            propertyValue = styles.getPropertyValue(propertyName);
        }
        element.style.setProperty(propertyName, propertyValue);
    }
}
function parseAndApplyStyles(element, sheet) {
    try {
        const computedStyle = getComputedStyle(element);
        for (let i = 0; i < sheet.cssRules.length; i++) {
            const rule = sheet.cssRules[i];
            if (rule instanceof CSSStyleRule && element.matches(rule.selectorText)) {
                applyStyles(element, rule.style, computedStyle);
            }
        }
        // Claude Code Update
    }
    catch (e) {
        // 移除 console.warn 避免污染开发者控制台
    }
}
function traverse(root, sheet) {
    let element = root.firstElementChild;
    while (element) {
        if (element.tagName === 'svg') {
            // pass
        }
        else {
            traverse(element, sheet);
        }
        element = element.nextElementSibling;
    }
    parseAndApplyStyles(root, sheet);
}
export async function CSSProcess(content) {
    // 获取样式表
    const style = getStyleSheet();
    if (style) {
        traverse(content, style);
    }
}
export function parseCSS(css) {
    return postcss.parse(css);
}
export function ruleToStyle(rule) {
    let style = '';
    rule.walkDecls(decl => {
        style += decl.prop + ':' + decl.value + ';';
    });
    return style;
}
function processPseudoSelector(selector) {
    if (selector.includes('::before') || selector.includes('::after')) {
        selector = selector.replace(/::before/g, '').replace(/::after/g, '');
    }
    return selector;
}
function getPseudoType(selector) {
    if (selector.includes('::before')) {
        return 'before';
    }
    else if (selector.includes('::after')) {
        return 'after';
    }
    return undefined;
}
function applyStyle(root, cssRoot) {
    if (root.tagName.toLowerCase() === 'a' && root.classList.contains('wx_topic_link')) {
        return;
    }
    const cssText = root.style.cssText;
    cssRoot.walkRules(rule => {
        const selector = processPseudoSelector(rule.selector);
        try {
            if (root.matches(selector)) {
                let item = root;
                const pseudoType = getPseudoType(rule.selector);
                if (pseudoType) {
                    let content = '';
                    rule.walkDecls('content', decl => {
                        content = decl.value || '';
                    });
                    item = createSpan();
                    item.textContent = content.replace(/(^")|("$)/g, '');
                    if (pseudoType === 'before') {
                        root.prepend(item);
                    }
                    else if (pseudoType === 'after') {
                        root.appendChild(item);
                    }
                }
                rule.walkDecls(decl => {
                    // 如果已经设置了，则不覆盖
                    const setted = cssText.includes(decl.prop);
                    if (!setted || decl.important) {
                        item.style.setProperty(decl.prop, decl.value);
                    }
                });
            }
        }
        catch (err) {
            if (err.message && err.message.includes('is not a valid selector')) {
                return;
            }
            else {
                throw err;
            }
        }
    });
    if (root.tagName === 'svg') {
        return;
    }
    let element = root.firstElementChild;
    while (element) {
        applyStyle(element, cssRoot);
        element = element.nextElementSibling;
    }
}
// Claude Code Update: 保留outerHTML读取操作（用于最终HTML序列化输出到剪贴板）
export function applyCSS(html, css) {
    const doc = sanitizeHTMLToDom(html);
    const root = doc.firstChild;
    const cssRoot = postcss.parse(css);
    applyStyle(root, cssRoot);
    return root.outerHTML;
}
// Claude Code Update
// 禁用外部统计上报，避免API依赖
export function uevent(name) {
    // 本地统计，不发送到外部服务
    // 移除 console.log 避免污染开发者控制台
    // 原来的外部API调用已禁用
}
/**
 * 创建一个防抖函数
 * @param func 要执行的函数
 * @param wait 等待时间（毫秒）
 * @returns 防抖处理后的函数
 */
export function debounce(func, wait) {
    let timeout = null;
    return function (...args) {
        const context = this;
        const later = () => {
            timeout = null;
            func.apply(context, args);
        };
        if (timeout !== null) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(later, wait);
    };
}
export function cleanUrl(href) {
    try {
        href = encodeURI(href).replace(/%25/g, '%');
    }
    catch (e) {
        return null;
    }
    return href;
}
export async function waitForLayoutReady(app) {
    if (app.workspace.layoutReady) {
        return;
    }
    return new Promise((resolve) => {
        app.workspace.onLayoutReady(() => resolve());
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7O0dBWUc7QUFFSCxPQUFPLEVBQU8saUJBQWlCLEVBQWMsUUFBUSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3hFLE9BQU8sS0FBSyxPQUFPLE1BQU0sbUJBQW1CLENBQUM7QUFFN0MsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDO0FBQzVCLElBQUksWUFBWSxHQUFHLFVBQVUsQ0FBQztBQUU5QixNQUFNLFVBQVUsVUFBVSxDQUFDLE9BQWU7SUFDekMsYUFBYSxHQUFHLE9BQU8sQ0FBQztJQUN4QixJQUFJLFFBQVEsQ0FBQyxLQUFLLEVBQUU7UUFDbkIsWUFBWSxHQUFHLEtBQUssQ0FBQztLQUNyQjtTQUNJLElBQUksUUFBUSxDQUFDLE9BQU8sRUFBRTtRQUMxQixZQUFZLEdBQUcsS0FBSyxDQUFDO0tBQ3JCO1NBQ0ksSUFBSSxRQUFRLENBQUMsT0FBTyxFQUFFO1FBQzFCLFlBQVksR0FBRyxPQUFPLENBQUM7S0FDdkI7U0FDSSxJQUFJLFFBQVEsQ0FBQyxRQUFRLEVBQUU7UUFDM0IsWUFBWSxHQUFHLEtBQUssQ0FBQztLQUNyQjtTQUNJLElBQUksUUFBUSxDQUFDLFlBQVksRUFBRTtRQUMvQixZQUFZLEdBQUcsU0FBUyxDQUFDO0tBQ3pCO0FBQ0YsQ0FBQztBQUVELHFCQUFxQjtBQUNyQixTQUFTLGFBQWE7SUFDckIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3JELE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEMsSUFBSSxLQUFLLENBQUMsS0FBSyxJQUFJLGdCQUFnQixFQUFFO1lBQ25DLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7S0FDRDtBQUNGLENB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QUMzQixDQUFDLENBQUM7UUFFRixJQUFJLE9BQU8sS0FBSyxJQUFJLEVBQUU7WUFDckIsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3RCO1FBQ0QsT0FBTyxHQUFHLFVBQVUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQyxDQUFDO0FBQ0gsQ0FBQztBQUVELE1BQU0sVUFBVSxRQUFRLENBQUMsSUFBWTtJQUNuQyxJQUFJO1FBQ0YsSUFBSSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0tBQzdDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixPQUFPLElBQUksQ0FBQztLQUNiO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBRUQsTUFBTSxDQUFDLEtBQUssVUFBVSxrQkFBa0IsQ0FBQyxHQUFRO0lBQy9DLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7UUFDN0IsT0FBTztLQUNSO0lBQ0QsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzdCLEdBQUcsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDL0MsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoYykgMjAyNC0yMDI1IElzSGV4eFxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvZnR3YXJlIGlzIHByb3ByaWV0YXJ5IGFuZCBjb25maWRlbnRpYWwuIE5vIHBhcnQgb2YgdGhpcyBzb2Z0d2FyZVxuICogbWF5IGJlIHJlcHJvZHVjZWQsIGRpc3RyaWJ1dGVkLCBvciB0cmFuc21pdHRlZCBpbiBhbnkgZm9ybSBvciBieSBhbnkgbWVhbnMsXG4gKiBpbmNsdWRpbmcgcGhvdG9jb3B5aW5nLCByZWNvcmRpbmcsIG9yIG90aGVyIGVsZWN0cm9uaWMgb3IgbWVjaGFuaWNhbCBtZXRob2RzLFxuICogd2l0aG91dCB0aGUgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uIG9mIHRoZSBhdXRob3IsIGV4Y2VwdCBpbiB0aGUgY2FzZSBvZlxuICogYnJpZWYgcXVvdGF0aW9ucyBlbWJvZGllZCBpbiBjcml0aWNhbCByZXZpZXdzIGFuZCBjZXJ0YWluIG90aGVyIG5vbmNvbW1lcmNpYWxcbiAqIHVzZXMgcGVybWl0dGVkIGJ5IGNvcHlyaWdodCBsYXcuXG4gKlxuICogRm9yIHBlcm1pc3Npb24gcmVxdWVzdHMsIGNvbnRhY3Q6IElzSGV4eFxuICovXG5cbmltcG9ydCB7IEFwcCwgc2FuaXRpemVIVE1MVG9Eb20sIHJlcXVlc3RVcmwsIFBsYXRmb3JtIH0gZnJvbSBcIm9ic2lkaWFuXCI7XG5pbXBvcnQgKiBhcyBwb3N0Y3NzIGZyb20gXCIuL3Bvc3Rjc3MvcG9zdGNzc1wiO1xuXG5sZXQgUGx1Z2luVmVyc2lvbiA9IFwiMC4wLjBcIjtcbmxldCBQbHVnUGxhdGZvcm0gPSBcIm9ic2lkaWFuXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRWZXJzaW9uKHZlcnNpb246IHN0cmluZykge1xuXHRQbHVnaW5WZXJzaW9uID0gdmVyc2lvbjtcblx0aWYgKFBsYXRmb3JtLmlzV2luKSB7XG5cdFx0UGx1Z1BsYXRmb3JtID0gXCJ3aW5cIjtcblx0fVxuXHRlbHNlIGlmIChQbGF0Zm9ybS5pc01hY09TKSB7XG5cdFx0UGx1Z1BsYXRmb3JtID0gXCJtYWNcIjtcblx0fVxuXHRlbHNlIGlmIChQbGF0Zm9ybS5pc0xpbnV4KSB7XG5cdFx0UGx1Z1BsYXRmb3JtID0gXCJsaW51eFwiO1xuXHR9XG5cdGVsc2UgaWYgKFBsYXRmb3JtLmlzSW9zQXBwKSB7XG5cdFx0UGx1Z1BsYXRmb3JtID0gXCJpb3NcIjtcblx0fVxuXHRlbHNlIGlmIChQbGF0Zm9ybS5pc0FuZHJvaWRBcHApIHtcblx0XHRQbHVnUGxhdGZvcm0gPSBcImFuZHJvaWRcIjtcblx0fVxufVxuXG4vLyBDbGF1ZGUgQ29kZSBVcGRhdGVcbmZ1bmN0aW9uIGdldFN0eWxlU2hlZXQoKSB7XG5cdGZvciAobGV0IGkgPSAwOyBpIDwgZG9jdW1lbnQuc3R5bGVTaGVldHMubGVuZ3RoOyBpKyspIHtcblx0XHRjb25zdCBzaGVldCA9IGRvY3VtZW50LnN0eWxlU2hlZXRzW2ldO1xuXHRcdGlmIChzaGVldC50aXRsZSA9PSAnd2R3eGVkaXQtc3R5bGUnKSB7XG5cdFx0ICByZXR1cm4gc2hlZXQ7XG5cdFx0fVxuXHR9XG59XG5cbmZ1bmN0aW9uIGFwcGx5U3R5bGVzKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBzdHlsZXM6IENTU1N0eWxlRGVjbGFyYXRpb24sIGNvbXB1dGVkU3R5bGU6IENTU1N0eWxlRGVjbGFyYXRpb24pIHtcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBzdHlsZXMubGVuZ3RoOyBpKyspIHtcblx0XHRjb25zdCBwcm9wZXJ0eU5hbWUgPSBzdHlsZXNbaV07XG5cdFx0bGV0IHByb3BlcnR5VmFsdWUgPSBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHlOYW1lKTtcblx0XHRpZiAocHJvcGVydHlOYW1lID09ICd3aWR0aCcgJiYgc3R5bGVzLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHlOYW1lKSA9PSAnZml0LWNvbnRlbnQnKSB7XG5cdFx0XHRwcm9wZXJ0eVZhbHVlID0gJ2ZpdC1jb250ZW50Jztcblx0XHR9XG5cdFx0aWYgKHByb3BlcnR5TmFtZS5pbmRleE9mKCdtYXJnaW4nKSA+PSAwICYmIHN0eWxlcy5nZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5TmFtZSkuaW5kZXhPZignYXV0bycpID49IDApIHtcblx0XHQgICAgcHJvcGVydHlWYWx1ZSA9IHN0eWxlcy5nZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5TmFtZSk7XG5cdFx0fVxuXHRcdGVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkocHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlKTtcblx0fVxufVxuXG5mdW5jdGlvbiBwYXJzZUFuZEFwcGx5U3R5bGVzKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBzaGVldDpDU1NTdHlsZVNoZWV0KSB7XG5cdHRyeSB7XG5cdFx0Y29uc3QgY29tcHV0ZWRTdHlsZSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCk7XG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBzaGVldC5jc3NSdWxlcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0Y29uc3QgcnVsZSA9IHNoZWV0LmNzc1J1bGVzW2ldO1xuXHRcdFx0aWYgKHJ1bGUgaW5zdGFuY2VvZiBDU1NTdHlsZVJ1bGUgJiYgZWxlbWVudC5tYXRjaGVzKHJ1bGUuc2VsZWN0b3JUZXh0KSkge1xuXHRcdFx0ICBcdGFwcGx5U3R5bGVzKGVsZW1lbnQsIHJ1bGUuc3R5bGUsIGNvbXB1dGVkU3R5bGUpO1xuXHRcdFx0fVxuXHRcdH1cblx0Ly8gQ2xhdWRlIENvZGUgVXBkYXRlXG5cdH0gY2F0Y2ggKGUpIHtcblx0XHQvLyDnp7vpmaQgY29uc29sZS53YXJuIOmBv+WFjeaxoeafk+W8gOWPkeiAheaOp+WItuWPsFxuXHR9XG59XG5cbmZ1bmN0aW9uIHRyYXZlcnNlKHJvb3Q6IEhUTUxFbGVtZW50LCBzaGVldDpDU1NTdHlsZVNoZWV0KSB7XG5cdGxldCBlbGVtZW50ID0gcm9vdC5maXJzdEVsZW1lbnRDaGlsZDtcblx0d2hpbGUgKGVsZW1lbnQpIHtcblx0XHRpZiAoZWxlbWVudC50YWdOYW1lID09PSAnc3ZnJykge1xuXHRcdFx0Ly8gcGFzc1xuXHRcdH1cblx0XHRlbHNlIHtcblx0ICBcdFx0dHJhdmVyc2UoZWxlbWVudCBhcyBIVE1MRWxlbWVudCwgc2hlZXQpO1xuXHRcdH1cblx0ICBcdGVsZW1lbnQgPSBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZztcblx0fVxuXHRwYXJzZUFuZEFwcGx5U3R5bGVzKHJvb3QsIHNoZWV0KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIENTU1Byb2Nlc3MoY29udGVudDogSFRNTEVsZW1lbnQpIHtcblx0Ly8g6I635Y+W5qC35byP6KGoXG5cdGNvbnN0IHN0eWxlID0gZ2V0U3R5bGVTaGVldCgpO1xuXHRpZiAoc3R5bGUpIHtcblx0XHR0cmF2ZXJzZShjb250ZW50LCBzdHlsZSk7XG5cdH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlQ1NTKGNzczogc3RyaW5nKSB7XG5cdHJldHVybiBwb3N0Y3NzLnBhcnNlKGNzcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBydWxlVG9TdHlsZShydWxlOiBwb3N0Y3NzLlJ1bGUpIHtcblx0bGV0IHN0eWxlID0gJyc7XHRcblx0cnVsZS53YWxrRGVjbHMoZGVjbCA9PiB7XG5cdFx0c3R5bGUgKz0gZGVjbC5wcm9wICsgJzonICsgZGVjbC52YWx1ZSArICc7Jztcblx0fSlcblxuXHRyZXR1cm4gc3R5bGU7XG59XG5cbmZ1bmN0aW9uIHByb2Nlc3NQc2V1ZG9TZWxlY3RvcihzZWxlY3Rvcjogc3RyaW5nKSB7XG5cdGlmIChzZWxlY3Rvci5pbmNsdWRlcygnOjpiZWZvcmUnKSB8fCBzZWxlY3Rvci5pbmNsdWRlcygnOjphZnRlcicpKSB7XG5cdFx0c2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKC86OmJlZm9yZS9nLCAnJykucmVwbGFjZSgvOjphZnRlci9nLCAnJyk7XG5cdH1cblx0cmV0dXJuIHNlbGVjdG9yO1xufVxuXG5mdW5jdGlvbiBnZXRQc2V1ZG9UeXBlKHNlbGVjdG9yOiBzdHJpbmcpIHtcblx0aWYgKHNlbGVjdG9yLmluY2x1ZGVzKCc6OmJlZm9yZScpKSB7XG5cdFx0cmV0dXJuICdiZWZvcmUnO1xuXHR9XG5cdGVsc2UgaWYgKHNlbGVjdG9yLmluY2x1ZGVzKCc6OmFmdGVyJykpIHtcblx0XHRyZXR1cm4gJ2FmdGVyJztcblx0fVxuXHRyZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBhcHBseVN0eWxlKHJvb3Q6IEhUTUxFbGVtZW50LCBjc3NSb290OiBwb3N0Y3NzLlJvb3QpIHtcblx0aWYgKHJvb3QudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnYScgJiYgcm9vdC5jbGFzc0xpc3QuY29udGFpbnMoJ3d4X3RvcGljX2xpbmsnKSkge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGNvbnN0IGNzc1RleHQgPSByb290LnN0eWxlLmNzc1RleHQ7XG5cdGNzc1Jvb3Qud2Fsa1J1bGVzKHJ1bGUgPT4ge1xuXHRcdGNvbnN0IHNlbGVjdG9yID0gcHJvY2Vzc1BzZXVkb1NlbGVjdG9yKHJ1bGUuc2VsZWN0b3IpO1xuXHRcdHRyeSB7XG5cdFx0XHRpZiAocm9vdC5tYXRjaGVzKHNlbGVjdG9yKSkge1xuXHRcdFx0XHRsZXQgaXRlbSA9IHJvb3Q7XG5cblx0XHRcdFx0Y29uc3QgcHNldWRvVHlwZSA9IGdldFBzZXVkb1R5cGUocnVsZS5zZWxlY3Rvcik7XG5cdFx0XHRcdGlmIChwc2V1ZG9UeXBlKSB7XG5cdFx0XHRcdFx0bGV0IGNvbnRlbnQgPSAnJztcblx0XHRcdFx0XHRydWxlLndhbGtEZWNscygnY29udGVudCcsIGRlY2wgPT4ge1xuXHRcdFx0XHRcdFx0Y29udGVudCA9IGRlY2wudmFsdWUgfHwgJyc7XG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHRpdGVtID0gY3JlYXRlU3BhbigpO1xuXHRcdFx0XHRcdGl0ZW0udGV4dENvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UoLyheXCIpfChcIiQpL2csICcnKTtcblxuXHRcdFx0XHRcdGlmIChwc2V1ZG9UeXBlID09PSAnYmVmb3JlJykge1xuXHRcdFx0XHRcdFx0cm9vdC5wcmVwZW5kKGl0ZW0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlIGlmIChwc2V1ZG9UeXBlID09PSAnYWZ0ZXInKSB7XG5cdFx0XHRcdFx0XHRyb290LmFwcGVuZENoaWxkKGl0ZW0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJ1bGUud2Fsa0RlY2xzKGRlY2wgPT4ge1xuXHRcdFx0XHRcdC8vIOWmguaenOW3sue7j+iuvue9ruS6hu+8jOWImeS4jeimhuebllxuXHRcdFx0XHRcdGNvbnN0IHNldHRlZCA9IGNzc1RleHQuaW5jbHVkZXMoZGVjbC5wcm9wKTtcblx0XHRcdFx0XHRpZiAoIXNldHRlZCB8fCBkZWNsLmltcG9ydGFudCkge1xuXHRcdFx0XHRcdFx0aXRlbS5zdHlsZS5zZXRQcm9wZXJ0eShkZWNsLnByb3AsIGRlY2wudmFsdWUpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSlcblx0XHRcdH1cblx0XHR9XG5cdFx0Y2F0Y2ggKGVycikge1xuXHRcdFx0aWYgKGVyci5tZXNzYWdlICYmIGVyci5tZXNzYWdlLmluY2x1ZGVzKCdpcyBub3QgYSB2YWxpZCBzZWxlY3RvcicpKSB7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblx0XHRcdGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBlcnI7XG5cdFx0XHR9XG5cdFx0fVxuXHR9KTtcblxuXHRpZiAocm9vdC50YWdOYW1lID09PSAnc3ZnJykge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGxldCBlbGVtZW50ID0gcm9vdC5maXJzdEVsZW1lbnRDaGlsZDtcblx0d2hpbGUgKGVsZW1lbnQpIHtcblx0XHRhcHBseVN0eWxlKGVsZW1lbnQgYXMgSFRNTEVsZW1lbnQsIGNzc1Jvb3QpO1xuXHQgIFx0ZWxlbWVudCA9IGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nO1xuXHR9XG59XG5cbi8vIENsYXVkZSBDb2RlIFVwZGF0ZTog5L+d55WZb3V0ZXJIVE1M6K+75Y+W5pON5L2c77yI55So5LqO5pyA57uISFRNTOW6j+WIl+WMlui+k+WHuuWIsOWJqui0tOadv++8iVxuZXhwb3J0IGZ1bmN0aW9uIGFwcGx5Q1NTKGh0bWw6IHN0cmluZywgY3NzOiBzdHJpbmcpIHtcblx0Y29uc3QgZG9jID0gc2FuaXRpemVIVE1MVG9Eb20oaHRtbCk7XG5cdGNvbnN0IHJvb3QgPSBkb2MuZmlyc3RDaGlsZCBhcyBIVE1MRWxlbWVudDtcblx0Y29uc3QgY3NzUm9vdCA9IHBvc3Rjc3MucGFyc2UoY3NzKTtcblx0YXBwbHlTdHlsZShyb290LCBjc3NSb290KTtcblx0cmV0dXJuIHJvb3Qub3V0ZXJIVE1MO1xufVxuXG4vLyBDbGF1ZGUgQ29kZSBVcGRhdGVcbi8vIOemgeeUqOWklumDqOe7n+iuoeS4iuaKpe+8jOmBv+WFjUFQSeS+nei1llxuZXhwb3J0IGZ1bmN0aW9uIHVldmVudChuYW1lOiBzdHJpbmcpIHtcblx0Ly8g5pys5Zyw57uf6K6h77yM5LiN5Y+R6YCB5Yiw5aSW6YOo5pyN5YqhXG5cdC8vIOenu+mZpCBjb25zb2xlLmxvZyDpgb/lhY3msaHmn5PlvIDlj5HogIXmjqfliLblj7Bcblx0Ly8g5Y6f5p2l55qE5aSW6YOoQVBJ6LCD55So5bey56aB55SoXG59XG5cbi8qKlxuICog5Yib5bu65LiA5Liq6Ziy5oqW5Ye95pWwXG4gKiBAcGFyYW0gZnVuYyDopoHmiafooYznmoTlh73mlbBcbiAqIEBwYXJhbSB3YWl0IOetieW+heaXtumXtO+8iOavq+enku+8iVxuICogQHJldHVybnMg6Ziy5oqW5aSE55CG5ZCO55qE5Ye95pWwXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBkZWJvdW5jZTxUIGV4dGVuZHMgKC4uLmFyZ3M6IGFueVtdKSA9PiBhbnk+KGZ1bmM6IFQsIHdhaXQ6IG51bWJlcik6ICguLi5hcmdzOiBQYXJhbWV0ZXJzPFQ+KSA9PiB2b2lkIHtcblx0bGV0IHRpbWVvdXQ6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG5cblx0cmV0dXJuIGZ1bmN0aW9uKHRoaXM6IGFueSwgLi4uYXJnczogUGFyYW1ldGVyczxUPikge1xuXHRcdGNvbnN0IGNvbnRleHQgPSB0aGlzO1xuXG5cdFx0Y29uc3QgbGF0ZXIgPSAoKSA9PiB7XG5cdFx0XHR0aW1lb3V0ID0gbnVsbDtcblx0XHRcdGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7XG5cdFx0fTtcblxuXHRcdGlmICh0aW1lb3V0ICE9PSBudWxsKSB7XG5cdFx0XHRjbGVhclRpbWVvdXQodGltZW91dCk7XG5cdFx0fVxuXHRcdHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTtcblx0fTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFuVXJsKGhyZWY6IHN0cmluZykge1xuICB0cnkge1xuICAgIGhyZWYgPSBlbmNvZGVVUkkoaHJlZikucmVwbGFjZSgvJTI1L2csICclJyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4gaHJlZjtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdhaXRGb3JMYXlvdXRSZWFkeShhcHA6IEFwcCk6IFByb21pc2U8dm9pZD4ge1xuICBpZiAoYXBwLndvcmtzcGFjZS5sYXlvdXRSZWFkeSkge1xuICAgIHJldHVybjtcbiAgfVxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBhcHAud29ya3NwYWNlLm9uTGF5b3V0UmVhZHkoKCkgPT4gcmVzb2x2ZSgpKTtcbiAgfSk7XG59XG4iXX0=