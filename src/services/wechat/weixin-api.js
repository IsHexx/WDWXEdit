/*
 * Copyright (c) 2024-2025 IsHexx
 * All rights reserved.
 *
 * This software is proprietary and confidential. No part of this software
 * may be reproduced, distributed, or transmitted in any form or by any means,
 * including photocopying, recording, or other electronic or mechanical methods,
 * without the prior written permission of the author, except in the case of
 * brief quotations embodied in critical reviews and certain other noncommercial
 * uses permitted by copyright law.
 *
 * For permission requests, contact: IsHexx
 */
import { requestUrl, getBlobArrayBuffer } from "obsidian";
// 全部使用本地后端服务，不再依赖外部API
const LocalBackendHost = 'http://127.0.0.1:8000';
// 获取认证头部
function getAuthHeaders() {
    return {
        'X-API-Key': 'wdwxedit-api-key-2024',
        'Content-Type': 'application/json',
    };
}
// 通过后端代理获取微信Token
export async function wxGetToken(authkey, appid, secret) {
    const url = `${LocalBackendHost}/api/v1/wechat/access-token`;
    try {
        const requestBody = {
            app_id: appid,
            app_secret: secret
        };
        const res = await requestUrl({
            url,
            method: 'POST',
            throw: false,
            headers: getAuthHeaders(),
            body: JSON.stringify(requestBody)
        });
        const resData = res.json;
        if (resData.success) {
            const data = resData.data;
            return {
                json: {
                    token: data.access_token || '',
                    expires_in: data.expires_in || 7200
                },
                status: 200
            };
        }
        else {
            // 解析微信API错误码
            const errorMsg = resData.error || '获取Token失败';
            let code = 0;
            let message = errorMsg;
            if (errorMsg.includes('40125') || errorMsg.includes('AppSecret')) {
                code = 40125;
                message = 'AppSecret错误';
            }
            else if (errorMsg.includes('40164') || errorMsg.includes('IP')) {
                code = 40164;
                message = 'IP地址不在白名单中';
            }
            else if (errorMsg.includes('50002')) {
                code = 50002;
                message = '用户受限';
            }
            return {
                json: {
                    code,
                    message,
                    token: ''
                },
                status: 400
            };
        }
    }
    catch (error) {
        console.error('获取微信Token失败:', error);
        return {
            json: {
                code: 1,
                message: `获取Token失败: ${error}`,
                token: ''
            },
            status: 500
        };
    }
}
// 通过后端代理加密保存公众号信息
export async function wxEncrypt(authkey, wechat) {
    const url = `${LocalBackendHost}/api/v1/wechat/save-accounts`;
    try {
        const requestBody = {
            authkey,
            wechat
        };
        const res = await requestUrl({
            url,
            method: 'POST',
            throw: false,
            headers: getAuthHeaders(),
            body: JSON.stringify(requestBody)
        });
        const resData = res.json;
        if (resData.success) {
            return {
                json: resData.data,
                status: 200
            };
        }
        else {
            return {
                json: {
                    message: resData.error || '保存失败'
                },
                status: 400
            };
        }
    }
    catch (error) {
        console.error('保存公众号信息失败:', error);
        return {
            json: {
                message: `保存失败: ${error}`
            },
            status: 500
        };
    }
}
// Claude Code Remove: 移除wxKeyInfo函数，不再需要注册码验证
// 通过后端代理上传图片
export async function wxUploadImage(data, filename, token, type) {
    const url = `${LocalBackendHost}/api/v1/wechat/upload-image`;
    try {
        // 将Blob转为base64
        const arrayBuffer = await getBlobArrayBuffer(data);
        const base64String = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
        const requestBody = {
            image_data: base64String,
            filename: filename,
            access_token: token,
            type: type || null
        };
        const res = await requestUrl({
            url,
            method: 'POST',
            throw: false,
            headers: getAuthHeaders(),
            body: JSON.stringify(requestBody)
        });
        const resData = res.json;
        if (resData.success) {
            const data = resData.data;
            return {
                url: data.url || '',
                media_id: data.media_id || '',
                errcode: data.errcode || 0,
                errmsg: data.errmsg || '',
            };
        }
        else {
            return {
                url: '',
                media_id: '',
                errcode: 1,
                errmsg: resData.error || '上传失败',
            };
        }
    }
    catch (error) {
        console.error('上传图片失败:', error);
        return {
            url: '',
            media_id: '',
            errcode: 1,
            errmsg: `上传失败: ${error}`,
        };
    }
}
// 通过后端代理创建草稿
export async function wxAddDraft(token, data) {
    const url = `${LocalBackendHost}/api/v1/wechat/create-draft`;
    try {
        const articleData = {
            title: data.title,
            content: data.content,
            digest: data.digest || (data.title ? data.title.substring(0, 100) : ''),
            thumb_media_id: data.thumb_media_id || '',
            show_cover_pic: 1,
            author: data.author || '',
            content_source_url: data.content_source_url || '',
            need_open_comment: data.need_open_comment,
            only_fans_can_comment: data.only_fans_can_comment,
            pic_crop_235_1: data.pic_crop_235_1 || '',
            pic_crop_1_1: data.pic_crop_1_1 || ''
        };
        const requestBody = {
            articles: [articleData],
            access_token: token
        };
        const res = await requestUrl({
            url,
            method: 'POST',
            throw: false,
            headers: getAuthHeaders(),
            body: JSON.stringify(requestBody)
        });
        const resData = res.json;
        if (resData.success) {
            return {
                json: resData.data,
                status: 200
            };
        }
        else {
            return {
                json: {
                    errcode: 1,
                    errmsg: resData.error || '创建草稿失败'
                },
                status: 400
            };
        }
    }
    catch (error) {
        console.error('创建草稿失败:', error);
        return {
            json: {
                errcode: 1,
                errmsg: `创建草稿失败: ${error}`
            },
            status: 500
        };
    }
}
// 通过后端代理创建图文草稿
export async function wxAddDraftImages(token, data) {
    const url = `${LocalBackendHost}/api/v1/wechat/create-draft`;
    try {
        const articleData = {
            title: data.title,
            content: data.content,
            digest: data.title.substring(0, 100),
            article_type: data.article_type,
            thumb_media_id: '',
            show_cover_pic: 0,
            author: '',
            content_source_url: '',
            need_open_comment: data.need_open_commnet,
            only_fans_can_comment: data.only_fans_can_comment,
            image_info: data.image_info
        };
        const requestBody = {
            articles: [articleData],
            access_token: token
        };
        const res = await requestUrl({
            url,
            method: 'POST',
            throw: false,
            headers: getAuthHeaders(),
            body: JSON.stringify(requestBody)
        });
        const resData = res.json;
        if (resData.success) {
            return {
                json: resData.data,
                status: 200
            };
        }
        else {
            return {
                json: {
                    errcode: 1,
                    errmsg: resData.error || '创建图文草稿失败'
                },
                status: 400
            };
        }
    }
    catch (error) {
        console.error('创建图文草稿失败:', error);
        return {
            json: {
                errcode: 1,
                errmsg: `创建图文草稿失败: ${error}`
            },
            status: 500
        };
    }
}
// 通过后端代理获取素材列表
export async function wxBatchGetMaterial(token, type, offset = 0, count = 10) {
    const url = `${LocalBackendHost}/api/v1/wechat/batch-get-material`;
    try {
        const requestBody = {
            type,
            offset,
            count,
            access_token: token
        };
        const res = await requestUrl({
            url,
            method: 'POST',
            throw: false,
            headers: getAuthHeaders(),
            body: JSON.stringify(requestBody)
        });
        const resData = res.json;
        if (resData.success) {
            return resData.data;
        }
        else {
            return {
                errcode: 1,
                errmsg: resData.error || '获取素材列表失败',
                item: [],
                total_count: 0,
                item_count: 0
            };
        }
    }
    catch (error) {
        console.error('获取素材列表失败:', error);
        return {
            errcode: 1,
            errmsg: `获取素材列表失败: ${error}`,
            item: [],
            total_count: 0,
            item_count: 0
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2VpeGluLWFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIndlaXhpbi1hcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7OztHQVlHO0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBbUIsa0JBQWtCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFJM0UsdUJBQXVCO0FBQ3ZCLE1BQU0sZ0JBQWdCLEdBQUcsdUJBQXVCLENBQUM7QUFFakQsU0FBUztBQUNULFNBQVMsY0FBYztJQUNuQixPQUFPO1FBQ0gsV0FBVyxFQUFFLHVCQUF1QjtRQUNwQyxjQUFjLEVBQUUsa0JBQWtCO0tBQ3JDLENBQUM7QUFDTixDQUFDO0FBRUQsa0JBQWtCO0FBQ2xCLE1BQU0sQ0FBQyxLQUFLLFVBQVUsVUFBVSxDQUFDLE9BQWMsRUFBRSxLQUFZLEVBQUUsTUFBYTtJQUN4RSxNQUFNLEdBQUcsR0FBRyxHQUFHLGdCQUFnQiw2QkFBNkIsQ0FBQztJQUU3RCxJQUFJO1FBQ0EsTUFBTSxXQUFXLEdBQUc7WUFDaEIsTUFBTSxFQUFFLEtBQUs7WUFDYixVQUFVLEVBQUUsTUFBTTtTQUNyQixDQUFDO1FBRUYsTUFBTSxHQUFHLEdBQUcsTUFBTSxVQUFVLENBQUM7WUFDekIsR0FBRztZQUNILE1BQU0sRUFBRSxNQUFNO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixPQUFPLEVBQUUsY0FBYyxFQUFFO1lBQ3pCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztTQUNwQyxDQUFDLENBQUM7UUFFSCxNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3pCLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUNqQixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU87Z0JBQ0gsSUFBSSxFQUFFO29CQUNGLEtBQUssRUFBRSxJQUFJLENBQUMsWUFBWSxJQUFJLEVBQUU7b0JBQzlCLFVBQVUsRUFBRSxJ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Q1osT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEMsT0FBTztZQUNILE9BQU8sRUFBRSxDQUFDO1lBQ1YsTUFBTSxFQUFFLGFBQWEsS0FBSyxFQUFFO1lBQzVCLElBQUksRUFBRSxFQUFFO1lBQ1IsV0FBVyxFQUFFLENBQUM7WUFDZCxVQUFVLEVBQUUsQ0FBQztTQUNoQixDQUFDO0tBQ0w7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoYykgMjAyNC0yMDI1IElzSGV4eFxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvZnR3YXJlIGlzIHByb3ByaWV0YXJ5IGFuZCBjb25maWRlbnRpYWwuIE5vIHBhcnQgb2YgdGhpcyBzb2Z0d2FyZVxuICogbWF5IGJlIHJlcHJvZHVjZWQsIGRpc3RyaWJ1dGVkLCBvciB0cmFuc21pdHRlZCBpbiBhbnkgZm9ybSBvciBieSBhbnkgbWVhbnMsXG4gKiBpbmNsdWRpbmcgcGhvdG9jb3B5aW5nLCByZWNvcmRpbmcsIG9yIG90aGVyIGVsZWN0cm9uaWMgb3IgbWVjaGFuaWNhbCBtZXRob2RzLFxuICogd2l0aG91dCB0aGUgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uIG9mIHRoZSBhdXRob3IsIGV4Y2VwdCBpbiB0aGUgY2FzZSBvZlxuICogYnJpZWYgcXVvdGF0aW9ucyBlbWJvZGllZCBpbiBjcml0aWNhbCByZXZpZXdzIGFuZCBjZXJ0YWluIG90aGVyIG5vbmNvbW1lcmNpYWxcbiAqIHVzZXMgcGVybWl0dGVkIGJ5IGNvcHlyaWdodCBsYXcuXG4gKlxuICogRm9yIHBlcm1pc3Npb24gcmVxdWVzdHMsIGNvbnRhY3Q6IElzSGV4eFxuICovXG5cbmltcG9ydCB7IHJlcXVlc3RVcmwsIFJlcXVlc3RVcmxQYXJhbSwgZ2V0QmxvYkFycmF5QnVmZmVyIH0gZnJvbSBcIm9ic2lkaWFuXCI7XG4vLyDmm7TmlrBpbXBvcnTot6/lvoRcbmltcG9ydCB7IFd4U2V0dGluZ3MgfSBmcm9tICcuLi8uLi9jb3JlL3NldHRpbmdzJztcblxuLy8g5YWo6YOo5L2/55So5pys5Zyw5ZCO56uv5pyN5Yqh77yM5LiN5YaN5L6d6LWW5aSW6YOoQVBJXG5jb25zdCBMb2NhbEJhY2tlbmRIb3N0ID0gJ2h0dHA6Ly8xMjcuMC4wLjE6ODAwMCc7XG5cbi8vIOiOt+WPluiupOivgeWktOmDqFxuZnVuY3Rpb24gZ2V0QXV0aEhlYWRlcnMoKTogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgJ1gtQVBJLUtleSc6ICd3ZHd4ZWRpdC1hcGkta2V5LTIwMjQnLCAvLyDkvb/nlKjlkI7nq68uZW525Lit6YWN572u55qEQVBJIEtleVxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgIH07XG59XG5cbi8vIOmAmui/h+WQjuerr+S7o+eQhuiOt+WPluW+ruS/oVRva2VuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd3hHZXRUb2tlbihhdXRoa2V5OnN0cmluZywgYXBwaWQ6c3RyaW5nLCBzZWNyZXQ6c3RyaW5nKSB7XG4gICAgY29uc3QgdXJsID0gYCR7TG9jYWxCYWNrZW5kSG9zdH0vYXBpL3YxL3dlY2hhdC9hY2Nlc3MtdG9rZW5gO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgICAgICAgYXBwX2lkOiBhcHBpZCxcbiAgICAgICAgICAgIGFwcF9zZWNyZXQ6IHNlY3JldFxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdFVybCh7XG4gICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIHRocm93OiBmYWxzZSxcbiAgICAgICAgICAgIGhlYWRlcnM6IGdldEF1dGhIZWFkZXJzKCksXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXF1ZXN0Qm9keSlcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCByZXNEYXRhID0gcmVzLmpzb247XG4gICAgICAgIGlmIChyZXNEYXRhLnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXNEYXRhLmRhdGE7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGpzb246IHtcbiAgICAgICAgICAgICAgICAgICAgdG9rZW46IGRhdGEuYWNjZXNzX3Rva2VuIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICBleHBpcmVzX2luOiBkYXRhLmV4cGlyZXNfaW4gfHwgNzIwMFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAyMDBcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyDop6PmnpDlvq7kv6FBUEnplJnor6/noIFcbiAgICAgICAgICAgIGNvbnN0IGVycm9yTXNnID0gcmVzRGF0YS5lcnJvciB8fCAn6I635Y+WVG9rZW7lpLHotKUnO1xuICAgICAgICAgICAgbGV0IGNvZGUgPSAwO1xuICAgICAgICAgICAgbGV0IG1lc3NhZ2UgPSBlcnJvck1zZztcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGVycm9yTXNnLmluY2x1ZGVzKCc0MDEyNScpIHx8IGVycm9yTXNnLmluY2x1ZGVzKCdBcHBTZWNyZXQnKSkge1xuICAgICAgICAgICAgICAgIGNvZGUgPSA0MDEyNTtcbiAgICAgICAgICAgICAgICBtZXNzYWdlID0gJ0FwcFNlY3JldOmUmeivryc7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yTXNnLmluY2x1ZGVzKCc0MDE2NCcpIHx8IGVycm9yTXNnLmluY2x1ZGVzKCdJUCcpKSB7XG4gICAgICAgICAgICAgICAgY29kZSA9IDQwMTY0O1xuICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSAnSVDlnLDlnYDkuI3lnKjnmb3lkI3ljZXkuK0nO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvck1zZy5pbmNsdWRlcygnNTAwMDInKSkge1xuICAgICAgICAgICAgICAgIGNvZGUgPSA1MDAwMjtcbiAgICAgICAgICAgICAgICBtZXNzYWdlID0gJ+eUqOaIt+WPl+mZkCc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAganNvbjoge1xuICAgICAgICAgICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICB0b2tlbjogJydcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHN0YXR1czogNDAwXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign6I635Y+W5b6u5L+hVG9rZW7lpLHotKU6JywgZXJyb3IpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAganNvbjoge1xuICAgICAgICAgICAgICAgIGNvZGU6IDEsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYOiOt+WPllRva2Vu5aSx6LSlOiAke2Vycm9yfWAsXG4gICAgICAgICAgICAgICAgdG9rZW46ICcnXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3RhdHVzOiA1MDBcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbi8vIOmAmui/h+WQjuerr+S7o+eQhuWKoOWvhuS/neWtmOWFrOS8l+WPt+S/oeaBr1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHd4RW5jcnlwdChhdXRoa2V5OnN0cmluZywgd2VjaGF0OmFueVtdKSB7XG4gICAgY29uc3QgdXJsID0gYCR7TG9jYWxCYWNrZW5kSG9zdH0vYXBpL3YxL3dlY2hhdC9zYXZlLWFjY291bnRzYDtcbiAgICBcbiAgICB0cnkge1xuICAgICAgICBjb25zdCByZXF1ZXN0Qm9keSA9IHtcbiAgICAgICAgICAgIGF1dGhrZXksXG4gICAgICAgICAgICB3ZWNoYXRcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3RVcmwoe1xuICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICB0aHJvdzogZmFsc2UsXG4gICAgICAgICAgICBoZWFkZXJzOiBnZXRBdXRoSGVhZGVycygpLFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVxdWVzdEJvZHkpXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVzRGF0YSA9IHJlcy5qc29uO1xuICAgICAgICBpZiAocmVzRGF0YS5zdWNjZXNzKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGpzb246IHJlc0RhdGEuZGF0YSxcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDIwMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAganNvbjoge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiByZXNEYXRhLmVycm9yIHx8ICfkv53lrZjlpLHotKUnXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDQwMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+S/neWtmOWFrOS8l+WPt+S/oeaBr+Wksei0pTonLCBlcnJvcik7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBqc29uOiB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYOS/neWtmOWksei0pTogJHtlcnJvcn1gXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3RhdHVzOiA1MDBcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbi8vIENsYXVkZSBDb2RlIFJlbW92ZTog56e76Zmkd3hLZXlJbmZv5Ye95pWw77yM5LiN5YaN6ZyA6KaB5rOo5YaM56CB6aqM6K+BXG5cblxuLy8g6YCa6L+H5ZCO56uv5Luj55CG5LiK5Lyg5Zu+54mHXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd3hVcGxvYWRJbWFnZShkYXRhOiBCbG9iLCBmaWxlbmFtZTogc3RyaW5nLCB0b2tlbjogc3RyaW5nLCB0eXBlPzogc3RyaW5nKSB7XG4gICAgY29uc3QgdXJsID0gYCR7TG9jYWxCYWNrZW5kSG9zdH0vYXBpL3YxL3dlY2hhdC91cGxvYWQtaW1hZ2VgO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICAgIC8vIOWwhkJsb2LovazkuLpiYXNlNjRcbiAgICAgICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCBnZXRCbG9iQXJyYXlCdWZmZXIoZGF0YSk7XG4gICAgICAgIGNvbnN0IGJhc2U2NFN0cmluZyA9IGJ0b2EoU3RyaW5nLmZyb21DaGFyQ29kZSguLi5uZXcgVWludDhBcnJheShhcnJheUJ1ZmZlcikpKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgICAgICAgaW1hZ2VfZGF0YTogYmFzZTY0U3RyaW5nLFxuICAgICAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lLFxuICAgICAgICAgICAgYWNjZXNzX3Rva2VuOiB0b2tlbixcbiAgICAgICAgICAgIHR5cGU6IHR5cGUgfHwgbnVsbFxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdFVybCh7XG4gICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIHRocm93OiBmYWxzZSxcbiAgICAgICAgICAgIGhlYWRlcnM6IGdldEF1dGhIZWFkZXJzKCksXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXF1ZXN0Qm9keSlcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCByZXNEYXRhID0gcmVzLmpzb247XG4gICAgICAgIGlmIChyZXNEYXRhLnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXNEYXRhLmRhdGE7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHVybDogZGF0YS51cmwgfHwgJycsXG4gICAgICAgICAgICAgICAgbWVkaWFfaWQ6IGRhdGEubWVkaWFfaWQgfHwgJycsXG4gICAgICAgICAgICAgICAgZXJyY29kZTogZGF0YS5lcnJjb2RlIHx8IDAsXG4gICAgICAgICAgICAgICAgZXJybXNnOiBkYXRhLmVycm1zZyB8fCAnJyxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHVybDogJycsXG4gICAgICAgICAgICAgICAgbWVkaWFfaWQ6ICcnLFxuICAgICAgICAgICAgICAgIGVycmNvZGU6IDEsXG4gICAgICAgICAgICAgICAgZXJybXNnOiByZXNEYXRhLmVycm9yIHx8ICfkuIrkvKDlpLHotKUnLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+S4iuS8oOWbvueJh+Wksei0pTonLCBlcnJvcik7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB1cmw6ICcnLFxuICAgICAgICAgICAgbWVkaWFfaWQ6ICcnLFxuICAgICAgICAgICAgZXJyY29kZTogMSxcbiAgICAgICAgICAgIGVycm1zZzogYOS4iuS8oOWksei0pTogJHtlcnJvcn1gLFxuICAgICAgICB9O1xuICAgIH1cbn1cblxuLy8g5paw5bu66I2J56i/XG5leHBvcnQgaW50ZXJmYWNlIERyYWZ0QXJ0aWNsZSB7XG4gICAgdGl0bGU6IHN0cmluZztcbiAgICBhdXRob3I/OiBzdHJpbmc7XG4gICAgZGlnZXN0Pzogc3RyaW5nO1xuICAgIGNvdmVyPzogc3RyaW5nO1xuICAgIGNvbnRlbnQ6IHN0cmluZztcbiAgICBjb250ZW50X3NvdXJjZV91cmw/OiBzdHJpbmc7XG4gICAgdGh1bWJfbWVkaWFfaWQ6IHN0cmluZztcbiAgICBuZWVkX29wZW5fY29tbWVudD86IG51bWJlcjtcbiAgICBvbmx5X2ZhbnNfY2FuX2NvbW1lbnQ/OiBudW1iZXI7XG4gICAgcGljX2Nyb3BfMjM1XzE/OiBzdHJpbmc7XG4gICAgcGljX2Nyb3BfMV8xPzogc3RyaW5nO1xuICAgIGFwcGlkPzogc3RyaW5nO1xuICAgIHRoZW1lPzogc3RyaW5nO1xuICAgIGhpZ2hsaWdodD86IHN0cmluZztcbn1cblxuLy8g6YCa6L+H5ZCO56uv5Luj55CG5Yib5bu66I2J56i/XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd3hBZGREcmFmdCh0b2tlbjogc3RyaW5nLCBkYXRhOiBEcmFmdEFydGljbGUpIHtcbiAgICBjb25zdCB1cmwgPSBgJHtMb2NhbEJhY2tlbmRIb3N0fS9hcGkvdjEvd2VjaGF0L2NyZWF0ZS1kcmFmdGA7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgYXJ0aWNsZURhdGEgPSB7XG4gICAgICAgICAgICB0aXRsZTogZGF0YS50aXRsZSxcbiAgICAgICAgICAgIGNvbnRlbnQ6IGRhdGEuY29udGVudCxcbiAgICAgICAgICAgIGRpZ2VzdDogZGF0YS5kaWdlc3QgfHwgKGRhdGEudGl0bGUgPyBkYXRhLnRpdGxlLnN1YnN0cmluZygwLCAxMDApIDogJycpLFxuICAgICAgICAgICAgdGh1bWJfbWVkaWFfaWQ6IGRhdGEudGh1bWJfbWVkaWFfaWQgfHwgJycsXG4gICAgICAgICAgICBzaG93X2NvdmVyX3BpYzogMSxcbiAgICAgICAgICAgIGF1dGhvcjogZGF0YS5hdXRob3IgfHwgJycsXG4gICAgICAgICAgICBjb250ZW50X3NvdXJjZV91cmw6IGRhdGEuY29udGVudF9zb3VyY2VfdXJsIHx8ICcnLFxuICAgICAgICAgICAgbmVlZF9vcGVuX2NvbW1lbnQ6IGRhdGEubmVlZF9vcGVuX2NvbW1lbnQsXG4gICAgICAgICAgICBvbmx5X2ZhbnNfY2FuX2NvbW1lbnQ6IGRhdGEub25seV9mYW5zX2Nhbl9jb21tZW50LFxuICAgICAgICAgICAgcGljX2Nyb3BfMjM1XzE6IGRhdGEucGljX2Nyb3BfMjM1XzEgfHwgJycsXG4gICAgICAgICAgICBwaWNfY3JvcF8xXzE6IGRhdGEucGljX2Nyb3BfMV8xIHx8ICcnXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBjb25zdCByZXF1ZXN0Qm9keSA9IHtcbiAgICAgICAgICAgIGFydGljbGVzOiBbYXJ0aWNsZURhdGFdLFxuICAgICAgICAgICAgYWNjZXNzX3Rva2VuOiB0b2tlblxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdFVybCh7XG4gICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIHRocm93OiBmYWxzZSxcbiAgICAgICAgICAgIGhlYWRlcnM6IGdldEF1dGhIZWFkZXJzKCksXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXF1ZXN0Qm9keSlcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCByZXNEYXRhID0gcmVzLmpzb247XG4gICAgICAgIGlmIChyZXNEYXRhLnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAganNvbjogcmVzRGF0YS5kYXRhLFxuICAgICAgICAgICAgICAgIHN0YXR1czogMjAwXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBqc29uOiB7XG4gICAgICAgICAgICAgICAgICAgIGVycmNvZGU6IDEsXG4gICAgICAgICAgICAgICAgICAgIGVycm1zZzogcmVzRGF0YS5lcnJvciB8fCAn5Yib5bu66I2J56i/5aSx6LSlJ1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc3RhdHVzOiA0MDBcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCfliJvlu7rojYnnqL/lpLHotKU6JywgZXJyb3IpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAganNvbjoge1xuICAgICAgICAgICAgICAgIGVycmNvZGU6IDEsXG4gICAgICAgICAgICAgICAgZXJybXNnOiBg5Yib5bu66I2J56i/5aSx6LSlOiAke2Vycm9yfWBcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdGF0dXM6IDUwMFxuICAgICAgICB9O1xuICAgIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBEcmFmdEltYWdlTWVkaWFJZCB7XG4gICAgaW1hZ2VfbWVkaWFfaWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEcmFmdEltYWdlSW5mbyB7XG4gICAgaW1hZ2VfbGlzdDogRHJhZnRJbWFnZU1lZGlhSWRbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEcmFmdEltYWdlcyB7XG4gICAgYXJ0aWNsZV90eXBlOiBzdHJpbmc7XG4gICAgdGl0bGU6IHN0cmluZztcbiAgICBjb250ZW50OiBzdHJpbmc7XG4gICAgbmVlZF9vcGVuX2NvbW1uZXQ6IG51bWJlcjtcbiAgICBvbmx5X2ZhbnNfY2FuX2NvbW1lbnQ6IG51bWJlcjtcbiAgICBpbWFnZV9pbmZvOiBEcmFmdEltYWdlSW5mbztcbn1cblxuLy8g6YCa6L+H5ZCO56uv5Luj55CG5Yib5bu65Zu+5paH6I2J56i/XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd3hBZGREcmFmdEltYWdlcyh0b2tlbjogc3RyaW5nLCBkYXRhOiBEcmFmdEltYWdlcykge1xuICAgIGNvbnN0IHVybCA9IGAke0xvY2FsQmFja2VuZEhvc3R9L2FwaS92MS93ZWNoYXQvY3JlYXRlLWRyYWZ0YDtcbiAgICBcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBhcnRpY2xlRGF0YSA9IHtcbiAgICAgICAgICAgIHRpdGxlOiBkYXRhLnRpdGxlLFxuICAgICAgICAgICAgY29udGVudDogZGF0YS5jb250ZW50LFxuICAgICAgICAgICAgZGlnZXN0OiBkYXRhLnRpdGxlLnN1YnN0cmluZygwLCAxMDApLFxuICAgICAgICAgICAgYXJ0aWNsZV90eXBlOiBkYXRhLmFydGljbGVfdHlwZSxcbiAgICAgICAgICAgIHRodW1iX21lZGlhX2lkOiAnJyxcbiAgICAgICAgICAgIHNob3dfY292ZXJfcGljOiAwLFxuICAgICAgICAgICAgYXV0aG9yOiAnJyxcbiAgICAgICAgICAgIGNvbnRlbnRfc291cmNlX3VybDogJycsXG4gICAgICAgICAgICBuZWVkX29wZW5fY29tbWVudDogZGF0YS5uZWVkX29wZW5fY29tbW5ldCxcbiAgICAgICAgICAgIG9ubHlfZmFuc19jYW5fY29tbWVudDogZGF0YS5vbmx5X2ZhbnNfY2FuX2NvbW1lbnQsXG4gICAgICAgICAgICBpbWFnZV9pbmZvOiBkYXRhLmltYWdlX2luZm9cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgICAgICAgYXJ0aWNsZXM6IFthcnRpY2xlRGF0YV0sXG4gICAgICAgICAgICBhY2Nlc3NfdG9rZW46IHRva2VuXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0VXJsKHtcbiAgICAgICAgICAgIHVybCxcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgdGhyb3c6IGZhbHNlLFxuICAgICAgICAgICAgaGVhZGVyczogZ2V0QXV0aEhlYWRlcnMoKSxcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJlcXVlc3RCb2R5KVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlc0RhdGEgPSByZXMuanNvbjtcbiAgICAgICAgaWYgKHJlc0RhdGEuc3VjY2Vzcykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBqc29uOiByZXNEYXRhLmRhdGEsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAyMDBcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGpzb246IHtcbiAgICAgICAgICAgICAgICAgICAgZXJyY29kZTogMSxcbiAgICAgICAgICAgICAgICAgICAgZXJybXNnOiByZXNEYXRhLmVycm9yIHx8ICfliJvlu7rlm77mlofojYnnqL/lpLHotKUnXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDQwMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+WIm+W7uuWbvuaWh+iNieeov+Wksei0pTonLCBlcnJvcik7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBqc29uOiB7XG4gICAgICAgICAgICAgICAgZXJyY29kZTogMSxcbiAgICAgICAgICAgICAgICBlcnJtc2c6IGDliJvlu7rlm77mlofojYnnqL/lpLHotKU6ICR7ZXJyb3J9YFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHN0YXR1czogNTAwXG4gICAgICAgIH07XG4gICAgfVxufVxuXG4vLyDpgJrov4flkI7nq6/ku6PnkIbojrflj5bntKDmnZDliJfooahcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3eEJhdGNoR2V0TWF0ZXJpYWwodG9rZW46IHN0cmluZywgdHlwZTogc3RyaW5nLCBvZmZzZXQ6IG51bWJlciA9IDAsIGNvdW50OiBudW1iZXIgPSAxMCkge1xuICAgIGNvbnN0IHVybCA9IGAke0xvY2FsQmFja2VuZEhvc3R9L2FwaS92MS93ZWNoYXQvYmF0Y2gtZ2V0LW1hdGVyaWFsYDtcbiAgICBcbiAgICB0cnkge1xuICAgICAgICBjb25zdCByZXF1ZXN0Qm9keSA9IHtcbiAgICAgICAgICAgIHR5cGUsXG4gICAgICAgICAgICBvZmZzZXQsXG4gICAgICAgICAgICBjb3VudCxcbiAgICAgICAgICAgIGFjY2Vzc190b2tlbjogdG9rZW5cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3RVcmwoe1xuICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICB0aHJvdzogZmFsc2UsXG4gICAgICAgICAgICBoZWFkZXJzOiBnZXRBdXRoSGVhZGVycygpLFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVxdWVzdEJvZHkpXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVzRGF0YSA9IHJlcy5qc29uO1xuICAgICAgICBpZiAocmVzRGF0YS5zdWNjZXNzKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzRGF0YS5kYXRhO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBlcnJjb2RlOiAxLFxuICAgICAgICAgICAgICAgIGVycm1zZzogcmVzRGF0YS5lcnJvciB8fCAn6I635Y+W57Sg5p2Q5YiX6KGo5aSx6LSlJyxcbiAgICAgICAgICAgICAgICBpdGVtOiBbXSxcbiAgICAgICAgICAgICAgICB0b3RhbF9jb3VudDogMCxcbiAgICAgICAgICAgICAgICBpdGVtX2NvdW50OiAwXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign6I635Y+W57Sg5p2Q5YiX6KGo5aSx6LSlOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGVycmNvZGU6IDEsXG4gICAgICAgICAgICBlcnJtc2c6IGDojrflj5bntKDmnZDliJfooajlpLHotKU6ICR7ZXJyb3J9YCxcbiAgICAgICAgICAgIGl0ZW06IFtdLFxuICAgICAgICAgICAgdG90YWxfY291bnQ6IDAsXG4gICAgICAgICAgICBpdGVtX2NvdW50OiAwXG4gICAgICAgIH07XG4gICAgfVxufSJdfQ==